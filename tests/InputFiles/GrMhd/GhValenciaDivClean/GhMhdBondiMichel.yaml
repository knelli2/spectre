# Distributed under the MIT License.
# See LICENSE.txt for details.

Executable: EvolveGhValenciaDivCleanBondiMichel
Testing:
  Check: parse;execute
  Timeout: 8
ExpectedOutput:
  - GhMhdBondiMichelVolume0.h5
  - GhMhdBondiMichelReductions.h5

---

ResourceInfo:
  AvoidGlobalProc0: false
  Singletons:
    AhA:
      Proc: Auto
      Exclusive: false

Evolution:
  InitialTime: 0.0
  InitialTimeStep: 0.0001
  TimeStepper:
    AdamsBashforth:
      Order: 3

PhaseChangeAndTriggers:
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 1000
          Offset: 5
    PhaseChanges:
      - VisitAndReturn(LoadBalancing)

AnalyticSolution: &InitialData
  BondiMichel:
    Mass: 1.0
    SonicRadius: 6.0
    SonicDensity: 1.0e-5
    PolytropicExponent: 1.4
    MagFieldStrength: 1.0e-2

DomainCreator:
  Sphere:
    InnerRadius: 1.9
    OuterRadius: 20.0
    Interior:
      ExciseWithBoundaryCondition:
        DirichletAnalytic:
          # AnalyticPrescription: *InitialData
    InitialRefinement: 1
    InitialGridPoints: 5
    UseEquiangularMap: true
    EquatorialCompression: None
    WhichWedges: All
    RadialPartitioning: []
    RadialDistribution: [Logarithmic]
    TimeDependentMaps: None
    OuterBoundaryCondition:
      DirichletAnalytic:
        # AnalyticPrescription: *InitialData

VariableFixing:
  FixConservatives:
    CutoffD: 1.0e-12
    MinimumValueOfD: 1.0e-12
    CutoffYe: 0.0
    MinimumValueOfYe: 0.0
    SafetyFactorForB: 1.0e-12
    SafetyFactorForS: 1.0e-12
  FixToAtmosphere:
    DensityOfAtmosphere: 1.0e-12
    DensityCutoff: 1.0e-12
    TransitionDensityCutoff: 1.0e-11
    MaxVelocityMagnitude: 1.0e-4

# Limiter:
#   Minmod:
#     Type: Muscl
#     TvbConstant: 50.0
#     DisableForDebugging: false

EvolutionSystem:
  ValenciaDivClean:
    DampingParameter: 0.0
  GeneralizedHarmonic:
    GaugeCondition:
      AnalyticChristoffel:
        AnalyticPrescription: *InitialData
    DampingFunctionGamma0:
      GaussianPlusConstant:
        Constant: 1.0
        Amplitude: 0.0
        Width: 1.0
        Center: [0.0, 0.0, 0.0]
    DampingFunctionGamma1:
      GaussianPlusConstant:
        Constant: -1.0
        Amplitude: 0.0
        Width: 1.0
        Center: [0.0, 0.0, 0.0]
    DampingFunctionGamma2:
      GaussianPlusConstant:
        Constant: 1.0
        Amplitude: 0.0
        Width: 1.0
        Center: [0.0, 0.0, 0.0]


SpatialDiscretization:
  BoundaryCorrection:
    ProductUpwindPenaltyAndRusanov:
      UpwindPenalty:
      Rusanov:
  DiscontinuousGalerkin:
    Formulation: StrongInertial
    Quadrature: GaussLobatto
    Subcell:
      RdmpDelta0: 1.0e-7
      RdmpEpsilon: 1.0e-3
      PerssonExponent: 4.0
      InitialData:
        RdmpDelta0: 1.0e-7
        RdmpEpsilon: 1.0e-3
        PerssonExponent: 4.0
      AlwaysUseSubcells: true
      SubcellToDgReconstructionMethod: DimByDim
      UseHalo: false
      OnlyDgBlocksAndGroups: None
      FiniteDifferenceDerivativeOrder: 2
    TciOptions:
      MinimumValueOfD: 1.0e-20
      MinimumValueOfYe: 1.0e-20
      MinimumValueOfTildeTau: 1.0e-50
      AtmosphereDensity: 1.01e-15
      SafetyFactorForB: 1.0e-12
      MagneticFieldCutoff: DoNotCheckMagneticField
  SubcellSolver:
    Reconstructor:
      MonotonisedCentralPrim:
    FilterOptions:
      SpacetimeDissipation: 0.1

Filtering:
  ExpFilter0:
    Alpha: 36
    HalfPower: 64
    Enable: true
    BlocksToFilter: All

EventsAndTriggers:
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 5
          Offset: 0
    Events:
      - ChangeSlabSize:
          DelayChange: 5
          StepChoosers:
            - Cfl:
                SafetyFactor: 0.6
            - Increase:
                Factor: 1.5
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 1
          Offset: 0
    Events:
      - ObserveNorms:
          SubfileName: Errors
          TensorsToObserve:
            - Name: Error(SpacetimeMetric)
              NormType: L2Norm
              Components: Sum
            - Name: Error(Pi)
              NormType: L2Norm
              Components: Sum
            - Name: Error(Phi)
              NormType: L2Norm
              Components: Sum
            - Name: Error(RestMassDensity)
              NormType: L2Norm
              Components: Sum
            - Name: Error(SpecificInternalEnergy)
              NormType: L2Norm
              Components: Sum
            - Name: Error(SpatialVelocity)
              NormType: L2Norm
              Components: Sum
            - Name: Error(MagneticField)
              NormType: L2Norm
              Components: Sum
            - Name: Error(DivergenceCleaningField)
              NormType: L2Norm
              Components: Sum
            - Name: Error(LorentzFactor)
              NormType: L2Norm
              Components: Sum
            - Name: Error(Pressure)
              NormType: L2Norm
              Components: Sum
            - Name: Error(SpecificEnthalpy)
              NormType: L2Norm
              Components: Sum
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 2
          Offset: 0
    Events:
      - ObserveFields:
          SubfileName: VolumeData
          VariablesToObserve:
            - SpacetimeMetric
            - RestMassDensity
            - Pressure
            - MagneticField
            - PointwiseL2Norm(GaugeConstraint)
          InterpolateToMesh: None
          CoordinatesFloatingPointType: Double
          FloatingPointTypes: [Double, Double, Double, Double, Double]
          OverrideObservationValue: None
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 5
          Offset: 0
    Events:
      - AhA
  - Trigger:
      Slabs:
        Specified:
          Values: [2]
    Events:
      - Completion

ApparentHorizons:
  AhA:
    InitialGuess:
      LMax: 4
      Radius: 2.2
      Center: [0.0, 0.0, 0.0]
    FastFlow:
      Flow: Fast
      Alpha: 1.0
      Beta: 0.5
      AbsTol: 1e-12
      TruncationTol: 1e-2
      DivergenceTol: 1.2
      DivergenceIter: 5
      MaxIts: 100
    Verbosity: Verbose

Observers:
  VolumeFileName: "GhMhdBondiMichelVolume"
  ReductionFileName: "GhMhdBondiMichelReductions"

Interpolator:
  DumpVolumeDataOnFailure: false

EventsAndDenseTriggers:

EventsRunAtCleanup:
