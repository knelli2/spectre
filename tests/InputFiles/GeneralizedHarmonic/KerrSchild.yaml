# Distributed under the MIT License.
# See LICENSE.txt for details.

# Executable: EvolveGhSingleBlackHole
# Check: parse;execute_check_output
# Timeout: 8
# ExpectedOutput:
#   GhKerrSchildVolume0.h5
#   GhKerrSchildReductions.h5
#   GhKerrSchildSurfaces.h5
# OutputFileChecks:
#   - Label: "check_horizon_find"
#     Subfile: "/AhA.dat"
#     FileGlob: "GhKerrSchildReductions.h5"
#     AbsoluteTolerance: 1e2

ResourceInfo:
  AvoidGlobalProc0: false
  Singletons:
    AhA:
      Proc: Auto
      Exclusive: false
    ExcisionBoundaryA:
      Proc: Auto
      Exclusive: false
    ControlSystemSingleAh: Auto
    Shape: Auto

Evolution:
  InitialTime: &InitialTime 0.0
  InitialTimeStep: 0.01
  TimeStepper:
    AdamsBashforth:
      Order: 1

PhaseChangeAndTriggers:
  - - Slabs:
       EvenlySpaced:
         # Current implementation checks wallclock at these global syncs
         Interval: 100
         Offset: 0
    - - CheckpointAndExitAfterWallclock:
          WallclockHours: None

InitialData: &InitialData
  KerrSchild:
    Mass: 1.0
    Spin: [0.0, 0.0, 0.0]
    Center: &Center [0.0, 0.0, 0.0]

DomainCreator:
  Sphere:
    InnerRadius: &InnerRadius 1.9
    OuterRadius: &OuterRadius 50
    Interior:
      ExciseWithBoundaryCondition:
        DirichletAnalytic:
          AnalyticPrescription: *InitialData
    InitialRefinement: 0
    InitialGridPoints: 7
    UseEquiangularMap: true
    EquatorialCompression: None
    RadialPartitioning: [6.0, 12.0, 20.0, 30.0]
    RadialDistribution: [6.0, 12.0, 20.0, 30.0]
    WhichWedges: All
    TimeDependence:
      Shape:
        InitialTime: *InitialTime
        LMax: &LMax 10
        Mass: 1
        Spin: [0, 0, 0]
        Center: *Center
        InnerRadius: *InnerRadius
        OuterRadius: *OuterRadius
    OuterBoundaryCondition:
      DirichletAnalytic:
        AnalyticPrescription: *InitialData

EvolutionSystem:
  GeneralizedHarmonic:
    GaugeCondition:
      AnalyticChristoffel:
        AnalyticPrescription: *InitialData
    # The parameter choices here come from our experience with the Spectral
    # Einstein Code (SpEC). They should be suitable for evolutions of a
    # perturbation of a Kerr-Schild black hole.
    DampingFunctionGamma0:
      GaussianPlusConstant:
        Constant: 0.001
        Amplitude: 3.0
        Width: 11.313708499
        Center: [0.0, 0.0, 0.0]
    DampingFunctionGamma1:
      GaussianPlusConstant:
        Constant: -1.0
        Amplitude: 0.0
        Width: 11.313708499
        Center: [0.0, 0.0, 0.0]
    DampingFunctionGamma2:
      GaussianPlusConstant:
        Constant: 0.001
        Amplitude: 1.0
        Width: 11.313708499
        Center: [0.0, 0.0, 0.0]

Filtering:
  ExpFilter0:
    Alpha: 36.0
    HalfPower: 64
    DisableForDebugging: False

SpatialDiscretization:
  BoundaryCorrection:
    UpwindPenalty:
  DiscontinuousGalerkin:
    Formulation: StrongInertial
    Quadrature: GaussLobatto

EventsAndTriggers:
  - - Slabs:
        EvenlySpaced:
          Interval: 100
          Offset: 2
    - - ObserveNorms:
          SubfileName: Norms
          TensorsToObserve:
            - Name: ThreeIndexConstraint
              NormType: L2Norm
              Components: Sum
            - Name: GaugeConstraint
              NormType: L2Norm
              Components: Sum
  - - TimeCompares:
        Comparison: GreaterThanOrEqualTo
        Value: 200
    - - Completion

EventsAndDenseTriggers:

Observers:
  VolumeFileName: "GhKerrSchildVolume"
  ReductionFileName: "GhKerrSchildReductions"
  SurfaceFileName: "GhKerrSchildSurfaces"

Interpolator:
  DumpVolumeDataOnFailure: false

ApparentHorizons:
  AhA: &AhA
    InitialGuess:
      Lmax: *LMax
      Radius: 2.2
      Center: *Center
    FastFlow:
      Flow: Fast
      Alpha: 1.0
      Beta: 0.5
      AbsTol: 1e-12
      TruncationTol: 1e-2
      DivergenceTol: 1.2
      DivergenceIter: 5
      MaxIts: 100
    Verbosity: Quiet
  ControlSystemSingleAh: *AhA

InterpolationTargets:
  ExcisionBoundaryA:
    Lmax: *LMax
    Center: *Center
    Radius: *InnerRadius
    AngularOrdering: "Strahlkorper"

ControlSystems:
  WriteDataToDisk: false
  MeasurementsPerUpdate: 4
  Shape:
    IsActive: true
    Averager:
      AverageTimescaleFraction: 0.25
      Average0thDeriv: false
    Controller:
      UpdateFraction: 0.03
    TimescaleTuner:
      InitialTimescales: 0.2
      MinTimescale: 1.0e-2
      MaxTimescale: 10.0
      IncreaseThreshold: 2.5e-4
      DecreaseThreshold: 1.0e-3
      IncreaseFactor: 1.01
      DecreaseFactor: 0.98
    ControlError:
